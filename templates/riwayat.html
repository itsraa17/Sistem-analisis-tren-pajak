<!-- riwayat.html-->

{% extends "base.html" %} {% block content %}

<div class="container-fluid" style="max-width: 1200px">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0"><i class="fas fa-history me-2"></i>Riwayat</h3>
    <div class="d-flex gap-2">
      <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Kembali
      </a>
      {% if file_list %}
      <button class="btn btn-outline-danger" onclick="confirmDeleteAll()">
        <i class="fas fa-trash-alt me-1"></i>Hapus Semua
      </button>
      {% endif %}
    </div>
  </div>

  {% if not file_list %}
  <!-- Empty State -->
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="fas fa-folder-open" style="font-size: 4rem; color: #6c757d"></i>
    </div>
    <h5 class="text-muted">Belum Ada Riwayat</h5>
    <p class="text-muted mb-4">
      Upload file Excel untuk mulai mendeteksi anomali pajak
    </p>
    <a href="/" class="btn btn-primary">
      <i class="fas fa-upload me-1"></i>Upload File
    </a>
  </div>
  {% else %}
  <!-- File List -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
          <thead class="table-dark">
            <tr>
              <th style="width: 50%">
                <i class="fas fa-file-excel me-1"></i>Nama File
              </th>
              <th class="text-center" style="width: 25%">
                <i class="fas fa-eye me-1"></i>Aksi
              </th>
              <th class="text-center" style="width: 25%">
                <i class="fas fa-trash me-1"></i>Hapus
              </th>
            </tr>
          </thead>
          <tbody>
            {% for file in file_list %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i
                    class="fas fa-file-excel text-success me-2"
                    style="font-size: 1.2em"
                  ></i>
                  <div>
                    <div class="fw-semibold">{{ file.filename }}</div>
                    <small class="text-muted"
                      >Batch ID: {{ file.batch_id[:8] }}...</small
                    >
                  </div>
                </div>
              </td>
              <td class="text-center">
                <a
                  href="{{ url_for('riwayat_detail', batch_id=file.batch_id) }}"
                  class="btn btn-outline-secondary"
                >
                  <i class="fas fa-eye me-1"></i>Lihat Detail
                </a>
              </td>
              <td class="text-center">
                <button
                  class="btn btn-sm btn-outline-danger"
                  onclick="confirmDelete('{{ file.batch_id }}', '{{ file.filename }}')"
                >
                  <i class="fas fa-trash me-1"></i>Hapus
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- File Count Info -->
  <div class="mt-3 text-center">
    <small class="text-muted">
      <i class="fas fa-info-circle me-1"></i>
      Total {{ file_list|length }} file dalam riwayat
    </small>
  </div>
  {% endif %}
</div>

<!-- Hidden form for individual delete -->
<form id="deleteForm" method="POST" style="display: none"></form>

<script>
  // Function for individual file delete
  function confirmDelete(batchId, filename) {
    if (
      confirm(
        `Yakin ingin menghapus riwayat "${filename}"?\n\nTindakan ini tidak dapat dibatalkan.`
      )
    ) {
      const form = document.getElementById("deleteForm");
      form.action = `/hapus/${batchId}`;
      form.submit();
    }
  }

  // Function for delete all - WORKING VERSION
  function confirmDeleteAll() {
    const fileCount = {{ file_list|length if file_list else 0 }};
    const confirmed = confirm(
      `Yakin ingin menghapus SEMUA riwayat?\n\n` +
      `${fileCount} file akan dihapus secara permanen.\n` +
      `Tindakan ini tidak dapat dibatalkan!`
    );

    if (confirmed) {
      // Show loading indicator
      const button = event.target.closest('button');
      const originalContent = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Menghapus...';

      // Create and submit form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '{{ url_for("hapus_semua_riwayat") }}';
      document.body.appendChild(form);
      form.submit();
    }
  }

  // Auto-hide alerts after 5 seconds if any
  document.addEventListener("DOMContentLoaded", function () {
    const alerts = document.querySelectorAll(".alert:not(.alert-warning)");
    alerts.forEach(function (alert) {
      setTimeout(function () {
        if (alert && alert.parentNode) {
          alert.style.transition = "opacity 0.5s";
          alert.style.opacity = "0";
          setTimeout(function () {
            if (alert.parentNode) {
              alert.remove();
            }
          }, 500);
        }
      }, 5000);
    });
  });
</script>

{% endblock %}
